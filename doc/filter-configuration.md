# フィルタ設定ガイド

## 概要

kiberagでは、RAG検索時に個人メモや日報などの特定カテゴリのドキュメントを除外する機能を提供しています。この機能により、より適切なコンテキストを提供できるようになります。

## 設定方法

### 環境変数での設定

`.env`ファイルまたは環境変数で除外カテゴリを設定できます：

```bash
# デフォルト設定（個人メモと日報を除外）
EXCLUDE_CATEGORIES=個人メモ,日報

# カスタム設定例
EXCLUDE_CATEGORIES=個人メモ,日報,機密情報,草案

# 除外しない場合
EXCLUDE_CATEGORIES=
```

### カテゴリの識別方法

カテゴリは以下の方法で識別されます：

1. **Kibelaフォルダ構造から自動抽出**
   - フォルダパス `/チーム名/プロジェクト名/カテゴリ名/...` の第3階層
   - 例：`/engineering/backend/個人メモ/daily-notes.md` → カテゴリ: `個人メモ`

2. **Front Matterからの指定**
   ```markdown
   ---
   title: 技術メモ
   category: 個人メモ
   ---
   ```

## 動作確認

### queryコマンドでの確認

```bash
# 除外フィルタが適用された検索
./kiberag query -q "APIの実装方法"

# ログで除外カテゴリを確認
# 出力例: "Excluding categories: [個人メモ 日報]"
```

### chatコマンドでの確認

```bash
# チャット開始時に除外フィルタが適用されます
./kiberag chat

# 会話中にコンテキスト取得時のログで確認可能
# 出力例: "Excluding categories from chat context: [個人メモ 日報]"
```

### 手動フィルタとの併用

ユーザー指定のフィルタと除外フィルタは自動的に統合されます：

```bash
# ユーザーフィルタ + 除外フィルタの併用
./kiberag query -q "検索クエリ" --filter '{"author":"特定の著者"}'

# この場合、以下のフィルタが適用されます：
# {
#   "author": "特定の著者",
#   "category": {"$nin": ["個人メモ", "日報"]}
# }
```

## フィルタ無効化

除外フィルタを一時的に無効化したい場合：

```bash
# 環境変数を空に設定
EXCLUDE_CATEGORIES= ./kiberag query -q "検索クエリ"
```

## 技術仕様

- **フィルタ形式**: S3 Vector compatible JSON filter
- **除外構文**: `{"category": {"$nin": ["カテゴリ1", "カテゴリ2"]}}`
- **統合方式**: ユーザーフィルタとの自動マージ
- **適用範囲**: `query`コマンドと`chat`コマンドの両方

## トラブルシューティング

### よくある問題

1. **除外が効かない場合**
   - カテゴリ名の大文字・小文字を確認
   - ログでフィルタ適用状況を確認
   - ベクトル化時にカテゴリメタデータが正しく設定されているか確認

2. **設定が反映されない場合**
   - `.env`ファイルの場所を確認
   - 環境変数の設定を確認：`echo $EXCLUDE_CATEGORIES`

3. **パフォーマンスへの影響**
   - 除外フィルタはS3 Vector側で処理されるため、パフォーマンスへの影響は最小限